version: '3.8'

services:
  terraform-executor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: terraform-executor
    ports:
      - "8001:8001"

    # Security constraints
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    # Resource limits
    mem_limit: 512m
    cpus: 1.0

    # Writable tmpfs mounts
    tmpfs:
      - /tmp:size=256m,mode=1777
      - /home/tfuser/.terraform.d:size=128m,mode=0755

    environment:
      # Application Settings
      - APP_NAME=Terraform Executor
      - APP_VERSION=1.0.0
      - DEBUG=true

      # Execution Settings
      - EXECUTION_TIMEOUT=300
      - WORKSPACE_DIR=/tmp/workspace
      - MAX_PLAN_SIZE_MB=50

      # Security Settings
      - ALLOW_NETWORK=true
      - BLOCKED_PROVIDERS=local-exec,external

      # Logging
      - LOG_LEVEL=INFO
      - LOG_FORMAT=json

      # Upload directory (mounted from API gateway)
      - UPLOAD_BASE_DIR=/uploads

    volumes:
      # Mount for development (comment out for production)
      - ./app:/app/app:ro
      # Mount uploads directory (shared with API gateway)
      - ../api-gateway/uploads:/uploads:ro

    restart: unless-stopped

    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

networks:
  default:
    name: terraform-cost-network
