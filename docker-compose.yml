version: "3.9"

# Production-grade Docker Compose for Terraform AWS Cost Estimation Platform
# Architecture: Multi-service, sandboxed Terraform execution, deterministic networking

services:
  # =============================================================================
  # DATA LAYER
  # =============================================================================

  postgres:
    image: postgres:15-alpine
    container_name: cost-estimator-postgres
    environment:
      POSTGRES_DB: pricing
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - cost-estimator-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: cost-estimator-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - cost-estimator-network
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # =============================================================================
  # BACKEND SERVICES
  # =============================================================================

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: cost-estimator-api
    ports:
      - "8080:8080"
    environment:
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/pricing
      - REDIS_URL=redis://redis:6379
      - PLAN_PARSER_URL=http://plan-parser:8001
      - METADATA_RESOLVER_URL=http://aws-metadata-resolver:8002
      - PRICING_ENGINE_URL=http://pricing-engine:8003
      - USAGE_MODELING_URL=http://usage-modeling-engine:8005
      - COST_AGGREGATION_URL=http://cost-aggregation-engine:8006
      - RESULTS_STORAGE_URL=http://results-storage:8007
      - TERRAFORM_RUNNER_URL=http://terraform-runner:8004
    networks:
      - cost-estimator-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      plan-parser:
        condition: service_started
      aws-metadata-resolver:
        condition: service_started
      pricing-engine:
        condition: service_started
      usage-modeling-engine:
        condition: service_started
      cost-aggregation-engine:
        condition: service_started
      results-storage:
        condition: service_started
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  terraform-runner:
    build:
      context: ./terraform-executor
      dockerfile: Dockerfile
    container_name: cost-estimator-terraform
    # SECURITY: Sandboxed execution environment
    read_only: true # Filesystem is read-only
    security_opt:
      - no-new-privileges:true # Prevent privilege escalation
    cap_drop:
      - ALL # Drop all capabilities
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=512m # Writable temp with security restrictions
    environment:
      - TF_IN_AUTOMATION=1
      - TF_INPUT=0
      - TF_CLI_ARGS=-no-color
    networks:
      - cost-estimator-network
    # SECURITY: Resource limits to prevent DoS
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    restart: unless-stopped

  plan-parser:
    build:
      context: ./plan-parser
      dockerfile: Dockerfile
    container_name: cost-estimator-parser
    environment:
      - PORT=8001
      - LOG_LEVEL=INFO
    networks:
      - cost-estimator-network
    restart: unless-stopped

  aws-metadata-resolver:
    build:
      context: ./metadata-resolver
      dockerfile: Dockerfile
    container_name: cost-estimator-metadata
    environment:
      - PORT=8002
      - AWS_REGION=${AWS_REGION:-us-east-1}
      # AWS credentials injected at runtime via environment or IAM role
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}
      - CACHE_TTL_AMI=3600
      - CACHE_TTL_INSTANCE_TYPE=86400
    networks:
      - cost-estimator-network
    restart: unless-stopped

  pricing-engine:
    build:
      context: ./pricing-engine
      dockerfile: Dockerfile
    container_name: cost-estimator-pricing
    environment:
      - PORT=8003
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/pricing
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - PRICE_LIST_BASE_URL=https://pricing.us-east-1.amazonaws.com
    networks:
      - cost-estimator-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  usage-modeling-engine:
    build:
      context: ./usage-modeling
      dockerfile: Dockerfile
    container_name: cost-estimator-usage
    environment:
      - PORT=8005
      - PROFILES_DIR=/app/profiles
      - DEFAULT_PROFILE=prod
    networks:
      - cost-estimator-network
    restart: unless-stopped

  cost-aggregation-engine:
    build:
      context: ./cost-aggregation
      dockerfile: Dockerfile
    container_name: cost-estimator-aggregation
    environment:
      - PORT=8006
      - LOG_LEVEL=INFO
    networks:
      - cost-estimator-network
    restart: unless-stopped

  results-storage:
    build:
      context: ./results-storage
      dockerfile: Dockerfile
    container_name: cost-estimator-storage
    environment:
      - PORT=8007
      - DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/results
    networks:
      - cost-estimator-network
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped

  # =============================================================================
  # FRONTEND
  # =============================================================================

  ui:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: cost-estimator-ui
    ports:
      - "3000:80"
    environment:
      - API_URL=http://api-gateway:8080
    networks:
      - cost-estimator-network
    depends_on:
      - api-gateway
    restart: unless-stopped

# =============================================================================
# NETWORKING
# =============================================================================

networks:
  cost-estimator-network:
    driver: bridge
    name: cost-estimator-network

# =============================================================================
# VOLUMES
# =============================================================================

volumes:
  postgres_data:
    name: cost-estimator-postgres-data
  redis_data:
    name: cost-estimator-redis-data
