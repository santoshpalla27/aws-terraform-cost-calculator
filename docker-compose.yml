version: '3.9'

# ================================================================================
# TERRAFORM COST INTELLIGENCE PLATFORM - SIMPLIFIED DOCKER COMPOSE
# ================================================================================
# This compose file includes only the implemented services:
# - Infrastructure: PostgreSQL, Redis
# - Services: Plan Interpreter, AWS Metadata Resolver, Pricing Engine,
#   Usage Engine, Cost Engine, Results Service, Frontend
# - Orchestration: API Gateway, Job Orchestrator
# ================================================================================

networks:
  cost-platform:
    driver: bridge

volumes:
  postgres_data:
  redis_data:


services:
  # ============================================================================
  # INFRASTRUCTURE SERVICES
  # ============================================================================

  postgres:
    image: postgres:15-alpine
    container_name: cost-platform-postgres
    networks:
      - cost-platform
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-cost_governance}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    container_name: cost-platform-redis
    networks:
      - cost-platform
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ============================================================================
  # APPLICATION SERVICES
  # ============================================================================

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: /api
    container_name: cost-platform-frontend
    networks:
      - cost-platform
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      NEXT_PUBLIC_API_URL: /api
    depends_on:
      - api-gateway
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: cost-platform-api-gateway
    networks:
      - cost-platform
    ports:
      - "8080:8080"
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: json
      JWT_ISSUER: ${JWT_ISSUER}
      JWT_AUDIENCE: ${JWT_AUDIENCE}
      RATE_LIMIT_RPS: ${RATE_LIMIT_RPS:-100}
      JOB_ORCHESTRATOR_URL: http://job-orchestrator:8001
      RESULTS_SERVICE_URL: http://results-service:8008
    depends_on:
      job-orchestrator:
        condition: service_healthy
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  job-orchestrator:
    build:
      context: ./job-orchestrator
      dockerfile: Dockerfile
    container_name: cost-platform-job-orchestrator
    networks:
      - cost-platform
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: json
      JOB_TIMEOUT_SECONDS: ${JOB_TIMEOUT_SECONDS:-300}
      MAX_RETRIES: ${MAX_RETRIES:-3}
      TERRAFORM_EXECUTOR_URL: http://terraform-executor:8002
      PLAN_INTERPRETER_URL: http://plan-interpreter:8003
      METADATA_RESOLVER_URL: http://aws-metadata-resolver:8004
      PRICING_ENGINE_URL: http://pricing-engine:8005
      USAGE_ENGINE_URL: http://usage-engine:8006
      COST_ENGINE_URL: http://cost-engine:8007
      RESULTS_SERVICE_URL: http://results-service:8008
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      terraform-executor:
        condition: service_healthy
      plan-interpreter:
        condition: service_healthy
      aws-metadata-resolver:
        condition: service_healthy
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  terraform-executor:
    build:
      context: ./terraform-executor
      dockerfile: Dockerfile
    container_name: cost-platform-terraform-executor
    networks:
      - cost-platform
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: json
      TERRAFORM_VERSION: ${TERRAFORM_VERSION:-1.6.0}
      EXECUTION_TIMEOUT: ${EXECUTION_TIMEOUT:-180}
      REDIS_URL: redis://redis:6379/0
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=512m
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  plan-interpreter:
    build:
      context: ./plan-interpreter
      dockerfile: Dockerfile
    container_name: cost-platform-plan-interpreter
    networks:
      - cost-platform
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: json
    depends_on:
      - terraform-executor
    healthcheck:
      test: [ "CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/internal/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=256m
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  aws-metadata-resolver:
    build:
      context: ./aws-metadata-resolver
      dockerfile: Dockerfile
    container_name: cost-platform-metadata-resolver
    networks:
      - cost-platform
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: json
      AWS_REGION: ${AWS_REGION:-us-east-1}
      # AWS credentials should come from IAM role or instance metadata
      # DO NOT set AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, AWS_SESSION_TOKEN
      METADATA_CACHE_TTL: ${METADATA_CACHE_TTL:-3600}
      REDIS_URL: redis://redis:6379/0
      ENABLE_CACHE: "true"
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  pricing-engine:
    build:
      context: ./pricing-engine
      dockerfile: Dockerfile
    container_name: cost-platform-pricing-engine
    networks:
      - cost-platform
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: json
      PRICING_CACHE_TTL: ${PRICING_CACHE_TTL:-86400}
      SUPPORTED_SERVICES: ${SUPPORTED_SERVICES:-ec2,ebs,elb,rds}
      REDIS_URL: redis://redis:6379/1
      ENABLE_CACHE: "true"
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  usage-engine:
    build:
      context: ./usage-modeling-engine
      dockerfile: Dockerfile
    container_name: cost-platform-usage-engine
    networks:
      - cost-platform
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: json
      DEFAULT_USAGE_PROFILE: ${DEFAULT_USAGE_PROFILE:-prod}
      PROFILES_PATH: /app/profiles
    volumes:
      - ./usage-modeling-engine/profiles:/app/profiles:ro
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  cost-engine:
    build:
      context: ./cost-aggregation-engine
      dockerfile: Dockerfile
    container_name: cost-platform-cost-engine
    networks:
      - cost-platform
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: json
      DEFAULT_CURRENCY: ${DEFAULT_CURRENCY:-USD}
      DECIMAL_PRECISION: ${DECIMAL_PRECISION:-28}
      ENABLE_DETERMINISM_HASH: "true"
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:rw,noexec,nosuid,size=256m
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  results-service:
    build:
      context: ./results-governance-service
      dockerfile: Dockerfile
    container_name: cost-platform-results-service
    networks:
      - cost-platform
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-production}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FORMAT: json
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-cost_governance}
      ENABLE_AUDIT_LOG: "true"
      RETENTION_DAYS: ${RETENTION_DAYS:-365}
      POLICY_PATH: /app/policies
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
